---
SPDX-License-Identifier: MIT
path: "/tutorials/kubernetes-on-hetzner-with-crio-flannel-and-hetzner-balancer"
slug: "kubernetes-on-hetzner-with-crio-flannel-and-hetzner-balancer"
date: "2025-01-07"
title: "INSTALLING A KUBERNETES CLUSTER ON HETZNER CLOUD VIRTUAL MACHINES + FLANNEL + INGRESS NGINX CONTROLLER + HETZNER TLS BALANCER"
short_description: "This guide contains instructions for installing a Kubernetes cluster using kubeadm and Helm"
tags: ["Kubernetes", "kubeadm", "Helm", "flannel", "CRI-O", "Nginx Ingress Controller", "Hetzner Balancer"]
author: "Dmitry Tiunov"
author_link: "https://github.com/DTiunov"
author_img: "https://avatars3.githubusercontent.com/u/....."
author_description: "Manipulating arrays of characters in modern text editors that need more RAM than we used to fly to the moon. But it's super awesome..."
language: "en"
available_languages: ["en", "ru"]
header_img: "header-x"
cta: "product"
---

## Introduction

This guide contains instructions for installing a Kubernetes cluster version 1.30 using [kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm) and Helm. 
We will install [CRI-O](https://cri-o.io) as CRI (Container Runtime Interface) and [Flannel](https://github.com/flannel-io/flannel) as CNI (Container Network Interface). I chose CRI-O for several reasons:
* CRI-O is more secure than a container due to its limited set of features and internal components, which reduces the attack surface
* CRI-O has a clear component structure that is published
* CRI-O has many users and an active community

By installing the components step by step, you will assemble the cluster as a constructor. You will learn how to manage the Hetzner balancer using the annotations specified in the values ​​file for the Ingress Controller. All cluster nodes will be located within a single Hetzner network. Requests from the Internet to the cluster will be made through the Hetzner load balancer. This configuration allows you to close cluster nodes from external connections with a firewall. It makes your cluster more secure.

**Prerequisites**

* 3 virtual machines in the Hetzner Cloud (1 for Control Plane, 2 for Workers) with the Ubuntu 24.04 operating system and connected to the same Hetzner Network
* Hetzner Cloud [API token](https://docs.hetzner.com/cloud/api/getting-started/generating-api-token) in the [Hetzner Cloud Console](https://console.hetzner.cloud)
* [TLS certificate](https://docs.hetzner.com/konsoleh/ssl/certificates/#how-to-import-an-existing-certificate) imported into the [Hetzner Cloud Console](https://console.hetzner.cloud)

**Example terminology**

* Username: `holu` (short for Hetzner OnLine User)
* Hostname: `<your_host>`
* Domain: `<example.com>`
* Subdomain: `<sub.example.com>`
* IP addresses (IPv4 and IPv6):
   * Server: `<10.0.0.1>`
   * Gateway `<192.0.2.254>`
   * Client private: `<198.51.100.1>`
   * Client public: `<203.0.113.1>`

## Step 1 - Configure repositories

In this step we will add the Kubernetes and CRI-O repositories on all cluster nodes

Setting the Kubernetes version as an environment variable

```bash
KUBERNETES_VERSION=v1.30
```

Adding Kubernetes key and repository
```bash
curl -fsSL https://pkgs.k8s.io/core:/stable:/$KUBERNETES_VERSION/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/$KUBERNETES_VERSION/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list
```

Adding CRI-O key and repository
```bash
curl -fsSL https://pkgs.k8s.io/addons:/cri-o:/prerelease:/main/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/cri-o-apt-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/cri-o-apt-keyring.gpg] https://pkgs.k8s.io/addons:/cri-o:/prerelease:/main/deb/ /" | tee /etc/apt/sources.list.d/cri-o.list
```

## Step 2 - Install packages

Here we will install the Kubernetes CRI package to enable using OCI (Open Container Initiative) compatible runtimes, and Kubernetes cluster components on all nodes

Updating list of available packages
```bash
apt update
```

Installing packages
```bash
apt install -y cri-o kubelet kubeadm kubectl
```

Disabling automatic updates for installed packages 
```bash
apt-mark hold kubelet kubeadm kubectl
```

## Step 3 - Operation System configuration

Kubernetes requires some preliminary operating system settings. If you are using the Ubuntu24.04 distribution provided by Hetzner, then you do not need to disable SWAP, just run the commands below on all nodes in the cluster

Enabling [br_netfilter](https://ebtables.netfilter.org/documentation/bridge-nf.html) kernel module
```bash
echo "br_netfilter" >> /etc/modules-load.d/modules.conf
```

Enabling IP forward. It allows packets to be routed between different networks, enabling communication between subnets or acting as a gateway
```bash
sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/g' /etc/sysctl.conf
```

Rebooting node to apply changes
```bash
reboot
```

## Step 4 - Initializate cluster

Cluster initialization is performed on the future Control Plane node. In our case, only 1 Control Plane node is assumed. To ensure fault tolerance in a production environment, you must use at least 3

Getting default init configuration file
```bash
kubeadm config print init-defaults > InitConfiguration.yaml
```

# Bootstrap token. You can get it by command "kubeadm token list"
bootstrapTokens.token: abcdef.0123456789abcdef 
# The IP address of your Control Plane node in the Hetzner network
localAPIEndpoint.advertiseAddress: 10.10.0.6
# Path to CRI-O socket file
nodeRegistration.criSocket: unix:///var/run/crio/crio.sock
# Set to "external" for running with an external cloud provider
nodeRegistration.kubeletExtraArgs.cloud-provider: external
# The IP address of your Control Plane node in the Hetzner network
nodeRegistration.kubeletExtraArgs.node-ip: 10.10.0.6
# The name of the Control Plane node
nodeRegistration.name: k8s-test-master-1
# Subject Alternative Names for API service certificate.
# It can be both, FQDN and local IP address of your Control Pane node
apiServer.certSANs: [' k8s-test-master-1.local.example.com ', '10.10.0.6']

Initializing the cluster
```bash
kubeadm init --config InitConfiguration.yaml
```

## Step 5 - Join nodes into the cluster


## Step 3 - Summary of Step (Optional)

Instructions for a step that is not necessary to complete the tutorial, but can be helpful.


## Conclusion

A short conclusion summarizing what the user has done, and maybe suggesting different courses of action they can now take.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: [submitter's name and email address here]

-->
